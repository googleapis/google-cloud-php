<?php
/**
 * Copyright 2023 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

namespace Google\Cloud\Dev;

use Symfony\Component\Finder\Exception\DirectoryNotFoundException;
use Symfony\Component\Finder\Finder;

/**
 * Helper for getting info about component API versions.
 *
 * @internal
 */
class ComponentPackage
{
    private const PROTO_REGEX = '#\* GENERATED CODE WARNING
 \* Generated by gapic-generator-php from the file
 \* https:\/\/github.com\/googleapis\/googleapis\/blob\/master\/(.*.proto)
 \* Updates to the above are reflected here through a refresh process#';
    private string $path;

    private const MIGRATION_V1 = 'v1';
    private const MIGRATION_V2 = 'v2';
    private const MIGRATION_V1_AND_V2 = 'v1 and v2';
    private const MIGRATION_NA = 'n/a';

    public function __construct(private Component $component, private string $name)
    {
        $this->path = $component->getPath() . '/src/' . $name;
    }

    public function getName(): string
    {
        return $this->name;
    }

    public function getProtoPackage(): string
    {
        $gapicClientFiles = $this->getV1GapicClientFiles() + $this->getV2ClientFiles();

        foreach ($gapicClientFiles as $file) {
            $gapicClientContent = file_get_contents($file);
            if (preg_match(self::PROTO_REGEX, $gapicClientContent, $matches)) {
                return dirname($matches[1]);
            }
        }

        return '';
    }

    public function getMigrationStatus()
    {
        $hasV1Clients = count($this->getV1GapicClientFiles()) > 0;
        $hasV2Clients = count($this->getV2ClientFiles()) > 0;
        if ($hasV1Clients) {
            return $hasV2Clients ? self::MIGRATION_V1_AND_V2 : self::MIGRATION_V1;
        }
        return $hasV2Clients ? self::MIGRATION_V2 : self::MIGRATION_NA;
    }

    public function getServiceAddress(): string
    {
        $gapicClientFiles = $this->getV1GapicClientFiles() + $this->getV2ClientFiles();
        $gapicClientClasses = array_map(fn ($fp) => $this->getClassFromFile($fp), $gapicClientFiles);

        foreach ($gapicClientClasses as $className) {
            // Access V1-surface public constant
            if (defined($className . '::SERVICE_ADDRESS')) {
                return constant($className . '::SERVICE_ADDRESS');
            }
            // Access V2-surface private constant
            if ($constants = (new \ReflectionClass($className))->getConstants()) {
                if (isset($constants['SERVICE_ADDRESS'])) {
                    return $constants['SERVICE_ADDRESS'];
                }
            }
        }
        return '';
    }

    public function getApiShortname(): string
    {
        $sa = $this->getServiceAddress();
        return substr($sa, 0, strpos($sa, '.'));
    }


    private function getV1GapicClientFiles(): array
    {
        return $this->getFilesInDir('*GapicClient.php', $this->path . '/Gapic');
    }

    private function getV2ClientFiles(): array
    {
        return $this->getFilesInDir('*Client.php', $this->path . '/Client');
    }

    private function getFilesInDir(string $pattern, string $dir): array
    {
        if (!is_dir($dir)) {
            return [];
        }
        $result = (new Finder())->files()->name($pattern)->in($dir);
        return array_map(fn ($file) => $file->getRealPath(), iterator_to_array($result));
    }

    private function getClassFromFile(string $filePath): string
    {
        foreach ($this->component->getNamespaces() as $namespace => $dir) {
            $gapicClientClass = str_replace($this->component->getPath() . '/' . $dir, $namespace, $filePath);
            $gapicClientClass = str_replace(['/', '.php'], ['\\', ''], $gapicClientClass);
            if (class_exists($gapicClientClass)) {
                return $gapicClientClass;
            }
        }
        throw new \Exception('No GAPIC client found in ' . $filePath);
    }
}
