name: Major Version Approval Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]
    branches: ['main']
  pull_request_review:
    types: [submitted, dismissed]

permissions:
  contents: read
  pull-requests: read
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  approval-check:
    runs-on: ubuntu-latest
    # testing
    # if: github.event.pull_request.user.login == 'release-please[bot]' && contains(github.event.pull_request.body, 'MAJOR_VERSION_ALLOWED=')
    if: contains(github.event.pull_request.body, 'MAJOR_VERSION_ALLOWED=')
    steps:
      # Step 1: Create the check run
      - name: Create Check Run
        id: create_check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: check } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Major Version Approval',
              head_sha: context.payload.pull_request.head.sha,
              status: 'in_progress',
            });
            return check.id;
      
      # Step 2: Check approvals and update check run
      - name: Check Approvals and Update Check Run
        uses: actions/github-script@v7
        if: always() # Run even if create_check fails, to report failure
        env:
          GH_TOKEN: ${{ secrets.SPLIT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REQUIRED_APPROVALS: 2
        with:
          script: |
            const { execSync } = require('child_process');

            let conclusion = 'failure';
            let summary = 'An unexpected error occurred during the approval check.';

            try {
              const check_run_id = ${{ steps.create_check.outputs.result }};
              if (!check_run_id) {
                throw new Error('Failed to create a check run in the previous step.');
              }

              const prNumber = process.env.PR_NUMBER;
              const requiredApprovals = parseInt(process.env.REQUIRED_APPROVALS, 10);

              console.log(`Fetching approvals for PR #${prNumber}...`);
              const approvalsCmd = `gh pr view ${prNumber} --json reviews --jq '[.reviews[] | select(.state == "APPROVED") | .author.login] | unique | .[]'`;
              let approvalsOutput = '';
              try {
                // execSync throws on non-zero exit code. jq may exit non-zero with no results.
                approvalsOutput = execSync(approvalsCmd, { encoding: 'utf8', env: process.env });
              } catch (e) {
                console.log('No approvals found or an error occurred fetching them. Continuing...');
                // approvalsOutput remains empty, which is handled below.
              }

              const approvals = approvalsOutput.trim() ? approvalsOutput.trim().split('\n') : [];
              console.log(`Approvals found: ${approvals.length}`);

              console.log('Fetching yoshi-php team members...');
              const teamMembersCmd = `gh api --paginate orgs/googleapis/teams/yoshi-php/members --jq '.[].login'`;
              const teamMembersOutput = execSync(teamMembersCmd, { encoding: 'utf8', env: process.env });
              if (!teamMembersOutput.trim()) {
                throw new Error('Could not fetch any members for the yoshi-php team.');
              }
              const teamMembers = new Set(teamMembersOutput.trim().split('\n'));

              const matchingApprovals = approvals.filter(login => teamMembers.has(login));
              const count = matchingApprovals.length;

              console.log(`Found ${count} approval(s) from the yoshi-php team.`);

              if (count >= requiredApprovals) {
                conclusion = 'success';
                summary = `Success: Approval requirement of ${requiredApprovals} met with ${count} approvals.`;
              } else {
                conclusion = 'failure';
                summary = `Error: Requires at least ${requiredApprovals} approvals from the yoshi-php team. Only ${count} found.`;
              }
            } catch (error) {
              console.error(error);
              summary = `An error occurred while checking approvals: ${error.message}`;
              conclusion = 'failure';
            }

            console.log(`Final conclusion: ${conclusion}`);
            console.log(`Final summary: ${summary}`);

            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: ${{ steps.create_check.outputs.result }},
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Major Version Approval',
                summary: summary
              }
            });

            // The step will now always succeed, but the Check Run status will still reflect the true outcome.
