name: Major Version Approval Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches: ['main']
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: read

jobs:
  major-version-approval-check:
    name: Major Version Approval Check
    runs-on: ubuntu-latest
    # removed conditional for testing
    # if: github.event.pull_request.user.login == 'release-please[bot]' && contains(github.event.pull_request.body, 'MAJOR_VERSION_ALLOWED=')
    if: contains(github.event.pull_request.body, 'MAJOR_VERSION_ALLOWED=')
    steps:
      - uses: actions/checkout@v5
      - name: Check for at least 2 approvals from yoshi-php members
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REQUIRED_APPROVALS: 2
        run: |
          set -eo pipefail

          echo "Fetching approvals for PR #$PR_NUMBER..."
          # Get a unique, sorted list of all users who have approved.
          approvals=$(gh pr view $PR_NUMBER --json reviews --jq '[.reviews[] | select(.state == "APPROVED") | .author.login] | unique | .[]' | sort -u)
          if [ -z "$approvals" ]; then
            echo "No approvals found on this PR."
            approvals=""
          fi

          echo "Fetching yoshi-php team members..."
          team_members=$(gh api --paginate orgs/googleapis/teams/yoshi-php/members --jq '.[].login' | sort -u)
          if [ -z "$team_members" ]; then
            echo "Error: Could not fetch any members for the yoshi-php team."
            exit 1
          fi

          # find and count the intersection of the two lists.
          count=$(echo "$team_members" | grep -F -x -f <(echo "$approvals") | wc -l)

          echo "Found $count approval(s) from the yoshi-php team."

          if [[ $count -lt $REQUIRED_APPROVALS ]]; then
            echo "Error: Requires at least $REQUIRED_APPROVALS approvals from the yoshi-php team. Only $count found."
            exit 1
          else
            echo "Success: Approval requirement of $REQUIRED_APPROVALS met."
          fi